version: "3"

silent: true

# includes:
#   crypto:
#     taskfile: crates/crypto/Taskfile.yml
#     dir: crates/crypto

vars:
  TASK_BINARY: task # the name of the task executable
  TEMPLATE_URL: "https://github.com/brxken128/template"
  REMOTE_TASKFILE_NAME: "RepoTaskfile.yml"
  REMOTE_TASKFILE_REPO: "brxken128/taskfiles"
  REMOTE_TASKFILE_BRANCH: "main"
  REMOTE_TASKFILE_URL: "https://$GAT@raw.githubusercontent.com/{{.REMOTE_TASKFILE_REPO}}/{{.REMOTE_TASKFILE_BRANCH}}/{{.REMOTE_TASKFILE_NAME}}"

tasks:
  default:
    desc: Lists all commands
    cmd: "{{.TASK_BINARY}} --list-all"

  # base tasks
  dev:
    desc: Runs `pnpm desktop dev`
    cmds:
      - pnpm desktop dev --no-watch
    aliases: [d]
  build:
    desc: Runs `pnpm desktop build`
    cmds:
      - pnpm desktop build --no-watch
    aliases: [b]

  # clean base tasks
  cdev:
    desc: Cleans all output directories and runs `pnpm i, prep, desktop dev`
    cmds:
      - task: clean
      - task: setup
      - task: dev
  cbuild:
    desc: Cleans all output directories and runs `pnpm i, prep, desktop build`
    cmds:
      - task: clean
      - task: setup
      - task: build

  # cleaning output dirs
  clean:
    run: once
    desc: Clean all output directories (on Windows, only the top `node_modules` is removed).
    cmds:
      # unix
      - cmd: rm -rf target && echo "Removing ./target" # manually delete as sometimes `cargo clean` fails
        platforms: [darwin, linux]
      - cmd: find . -name "node_modules" -type d -prune -exec echo "Removing {}" \; -exec rm -rf "{}" \;
        platforms: [darwin, linux]
      - cmd: find . -name "dist" -type d -prune -exec echo "Removing {}" \; -exec rm -rf "{}/*" \;
        platforms: [darwin, linux]

      # windows
      - cmd: rmdir /s /q "target" # manually delete as sometimes `cargo clean` fails
        platforms: [windows]
      - cmd: rmdir /s /q "node_modules" # i have no clue if this will work
        platforms: [windows]
    aliases: [c]

  rm-sd-dir:
    desc: This removes the Spacedrive data directory
    cmds:
      - cmd: rm -rf "$HOME/Library/Application Support/spacedrive"
        platforms: [darwin]
      - cmd: rm -rf "$HOME/.local/share/spacedrive"
        platforms: [linux]
      - cmd: rmdir /s /q "{{.USERPROFILE}}/AppData/Roaming/spacedrive" #?????
        platforms: [windows]
        # prompt: This is untested, are you sure you'd like to run?
    aliases: [rmsddir]

  rm-dot-sd:
    desc: This removes all `.spacedrive` files from your `$HOME` directory
    dir: "$HOME"
    cmds:
      - cmd: find . -name ".spacedrive" -type f -prune -exec echo "Removing {}" \; -exec rm -rf "{}" \;
        platforms: [darwin, linux]
    aliases: [rmdotsd]

  # setup stuff
  setup:
    desc: Runs pnpm i and prep
    cmds:
      - pnpm i
      - pnpm prep
    aliases: [s]

  # get-main-repo-name:
  #   internal: true
  #   cmds:
  #     - cmd: "git remote show origin | sed -n '/HEAD branch/s/.*: //p'"
  #       platforms: [darwin, linux]

  new-crate:
    desc: Create a new crate with hardened clippy lints
    cmds:
      - cmd: cargo generate --git "{{.TEMPLATE_URL}}"

  update:
    desc: Updates and overrides the current Taskfile from Github
    cmds:
      - "echo \"Pre-update hash: \" && b3sum --no-names Taskfile.yml"
      - curl -s -o Taskfile.yml "{{.REMOTE_TASKFILE_URL}}"
      - "echo \"Post-update hash: \" && b3sum --no-names Taskfile.yml"
